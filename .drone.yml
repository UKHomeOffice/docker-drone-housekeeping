matrix:
  DOCKER_REPO:
    - ukhomeofficedigital/drone-housekeeping
  DOCKER_REGISTRY:
    - quay.io
  DOCKER_USERNAME:
    - ukhomeofficedigital+drone_housekeeping
  DOCKER_HOST:
    - tcp://172.17.0.1:2375
  HELM_REPO:
    - ukhomeofficedigital/helm-drone-housekeeping
  HELM_REGISTRY:
    - quay.io
  HELM_USERNAME:
    - ukhomeofficedigital+helm_drone_housekeeping

#############################
# Docker image pipeline steps
#############################

pipeline:
  docker-build:
    image: docker:19.03.12
    commands:
      - docker build -t ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_COMMIT_SHA} .
    when:
      event:
        - pull_request
        - push
        - tag

  docker-tag:
    image: docker:19.03.12
    environment:
      docker_username: $DOCKER_USERNAME
    secrets:
      - docker_password
    commands:
      - docker login -u="${DOCKER_USERNAME}" -p=$${DOCKER_PASSWORD} ${DOCKER_REGISTRY}
      - docker tag ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_COMMIT_SHA} ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_TAG##docker-}
      - docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_COMMIT_SHA}
      - docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_TAG##docker-}
    when:
      tag: docker-*
      event: tag

  docker-latest:
    image: docker:19.03.12
    environment:
      docker_username: $DOCKER_USERNAME
    secrets:
      - docker_password
    commands:
      - docker login -u="${DOCKER_USERNAME}" -p=$${DOCKER_PASSWORD} ${DOCKER_REGISTRY}
      - docker tag ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_COMMIT_SHA} ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest
      - docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}:$${DRONE_COMMIT_SHA}
      - docker push ${DOCKER_REGISTRY}/${DOCKER_REPO}:latest
    when:
      event: push
      branch: master

###########################
# Helm chart pipeline steps
###########################

  helm_lint:
    image: quay.io/ukhomeofficedigital/helm:v3.2.4
    commands:
      - cd helm
      - helm lint
    when:
      event: [push, pull_request]

  helm_publish:
    image: quay.io/ukhomeofficedigital/helm:v3.2.4
    secrets:
      - helm_password
    commands:
      - export HELM_TAG=$${DRONE_TAG##helm-}
      - publish-chart.sh
    when:
      tag: helm-*
      event: tag